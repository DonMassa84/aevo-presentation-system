#!/usr/bin/env bash
set -euo pipefail

MODE="${1:-}"
test -n "${MODE:-}" || { echo "FAIL: usage: aevo-set-mode <rebuild|strategie|master|ultra-fast>"; exit 1; }

case "$MODE" in
  rebuild|strategie|master|ultra-fast|ultra_fast) : ;;
  *) echo "FAIL: unknown mode: $MODE"; exit 1 ;;
esac

if [ "$MODE" = "ultra-fast" ]; then MODE="ultra_fast"; fi

REPO="${REPO_DIR:-$HOME/aevo-presentation-system}"
SLIDES="$REPO/slides"
UNIT="aevo-wallpaper-loop.service"
ACTIVE="$SLIDES/_order_exam15.txt"
MODEFILE="$HOME/.cache/aevo_mode.txt"

test -x "$REPO/export/bin/aevo-build-orders" || { echo "FAIL: missing: $REPO/export/bin/aevo-build-orders"; exit 1; }
"$REPO/export/bin/aevo-build-orders" >/dev/null

SRC="$SLIDES/_order_${MODE}.txt"
test -s "$SRC" || { echo "FAIL: missing/empty: $SRC"; exit 1; }

cp -f "$SRC" "$ACTIVE"
test -s "$ACTIVE" || { echo "FAIL: cannot write: $ACTIVE"; exit 1; }

printf "%s\n" "$MODE" > "$MODEFILE"

if systemctl --user list-unit-files | grep -q "^${UNIT}"; then
  systemctl --user restart "$UNIT" >/dev/null 2>&1 || true
fi

echo "OK: MODE=$MODE"
echo "OK: ORDER=$ACTIVE ($(wc -l < "$ACTIVE") entries)"

if command -v aevo-which-slide >/dev/null 2>&1; then
  echo "OK: CURRENT=$(aevo-which-slide 2>/dev/null | head -n 1 || true)"
fi
