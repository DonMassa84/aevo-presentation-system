#!/usr/bin/env bash
set -euo pipefail

SVC="aevo-wallpaper-loop.service"
DROP="$HOME/.config/systemd/user/${SVC}.d"
MODECONF="$DROP/mode.conf"

mkdir -p "$DROP"

cmd="${1:-}"

usage() {
  echo "Usage:"
  echo "  aevo-mode passive|recall|exam"
  echo "  aevo-mode test5|test10|testoff"
  echo "  aevo-mode info"
  exit 1
}

case "$cmd" in
  passive|recall|exam)
    printf '%s\n' '[Service]' "Environment=AEVO_MODE=$cmd" > "$MODECONF"
    ;;
  test5)
    printf '%s\n' '[Service]' 'Environment=AEVO_TEST_SEC=5' >> "$MODECONF"
    ;;
  test10)
    printf '%s\n' '[Service]' 'Environment=AEVO_TEST_SEC=10' >> "$MODECONF"
    ;;
  testoff)
    sed -i '/AEVO_TEST_SEC/d' "$MODECONF" 2>/dev/null || true
    ;;
  info)
    systemctl --user show "$SVC" -p Environment -p ExecStart -p ActiveState --no-pager || true
    exit 0
    ;;
  *)
    usage
    ;;
esac

systemctl --user daemon-reload
systemctl --user restart "$SVC"
systemctl --user --no-pager status "$SVC" | sed -n '1,18p' || true
