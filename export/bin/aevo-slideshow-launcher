#!/usr/bin/env bash
set -euo pipefail

REPO="${REPO_DIR:-$HOME/aevo-presentation-system}"
export PATH="$HOME/.local/bin:$REPO/export/bin:$PATH"

need_cmd() { command -v "$1" >/dev/null 2>&1; }

if need_cmd yad; then
  GUI="yad"
elif need_cmd zenity; then
  GUI="zenity"
else
  notify-send "AEVO Slideshow" "GUI fehlt. Installiere: sudo apt install yad" -t 4000 >/dev/null 2>&1 || true
  echo "FAIL: GUI fehlt (yad/zenity)."
  exit 1
fi

UNIT="aevo-wallpaper-loop.service"
if systemctl --user is-active "$UNIT" >/dev/null 2>&1; then
  STATUS="ðŸŸ¢ AKTIV"
else
  STATUS="ðŸ”´ GESTOPPT"
fi

run_mode() {
  local m="$1"
  case "$m" in
    Rebuild)      aevo-mode-rebuild ;;
    Strategie)    aevo-mode-strategie ;;
    Master)       aevo-mode-master ;;
    Ultra-Fast)   aevo-mode-ultra-fast ;;
    Status)
      if need_cmd aevo-which-slide; then
        ( echo "Status: $STATUS"
          echo
          echo "Aktuelle Folie:"
          aevo-which-slide 2>/dev/null || true
        ) | (zenity --text-info --title="AEVO Status" --width=700 --height=450 2>/dev/null || yad --text-info --title="AEVO Status" --width=700 --height=450 2>/dev/null || cat)
      else
        ( echo "Status: $STATUS"
          echo
          echo "Tipp: aevo-which-slide / aevo-watch-slide"
        ) | (zenity --text-info --title="AEVO Status" --width=700 --height=450 2>/dev/null || yad --text-info --title="AEVO Status" --width=700 --height=450 2>/dev/null || cat)
      fi
      ;;
    Stoppen)
      systemctl --user stop "$UNIT" >/dev/null 2>&1 || true
      pkill -f "aevo-wallpaper-loop\.sh" >/dev/null 2>&1 || true
      ;;
    *) exit 0 ;;
  esac
}

if [ "$GUI" = "yad" ]; then
  choice="$(yad --list \
    --title="AEVO Slideshow Manager" \
    --text="Status: $STATUS\n\nWÃ¤hle einen Modus:" \
    --column="Modus" --column="Beschreibung" \
    "Rebuild"    "Didaktik: Introâ†’Zielâ†’Methodeâ†’Demoâ†’Ãœbenâ†’LKKâ†’Fragen" \
    "Strategie"  "Gleiches GerÃ¼st, ruhiger Fokus (PrÃ¼fungsmodus)" \
    "Master"     "Alle Slides, stabil sortiert" \
    "Ultra-Fast" "Kurzloop: Zielâ†’Methodeâ†’LKKâ†’Fragen" \
    "Status"     "Zeigt Status + aktuelle Folie" \
    "Stoppen"    "Loop stoppen" \
    --width=740 --height=420 \
    --button="Starten:0" --button="Abbrechen:1")" || exit 0
  mode="$(printf "%s" "$choice" | cut -d'|' -f1)"
else
  mode="$(zenity --list \
    --title="AEVO Slideshow Manager" \
    --text="Status: $STATUS\n\nWÃ¤hle einen Modus:" \
    --column="Modus" --column="Beschreibung" \
    "Rebuild"    "Didaktik" \
    "Strategie"  "PrÃ¼fungsmodus" \
    "Master"     "Alle Slides" \
    "Ultra-Fast" "Kurzloop" \
    "Status"     "Status + aktuelle Folie" \
    "Stoppen"    "Stop" \
    --width=650 --height=420)" || exit 0
fi

run_mode "$mode"
