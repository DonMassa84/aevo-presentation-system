#!/usr/bin/env bash
set -euo pipefail
ENV_FILE="$HOME/.config/aevo-coach/env"
VENV="$HOME/.local/share/aevo-coach/.venv"
PY="$VENV/bin/python"

test -s "$ENV_FILE" || { echo "FAIL: env fehlt/leer: $ENV_FILE"; exit 1; }
test -x "$PY" || { echo "FAIL: venv python fehlt: $PY"; exit 1; }

set -a
. "$ENV_FILE"
set +a

"$PY" - << 'PY'
import os, sys
from openai import OpenAI

key=os.getenv("OPENAI_API_KEY","")
model=os.getenv("OPENAI_MODEL","gpt-4o-mini")

if len(key) < 20:
    print("API_CALL=FAIL")
    print("REASON=OPENAI_API_KEY fehlt/zu kurz")
    sys.exit(2)

client = OpenAI()

try:
    r = client.responses.create(
        model=model,
        input="Antworte exakt mit: OK"
    )
    out = (getattr(r, "output_text", "") or "").strip()
    print("API_CALL=OK")
    print("MODEL=" + model)
    print("OUTPUT=" + (out[:120] if out else ""))
    sys.exit(0)
except Exception as e:
    print("API_CALL=FAIL")
    print("MODEL=" + model)
    print(type(e).__name__ + ": " + str(e)[:400])
    sys.exit(1)
PY
