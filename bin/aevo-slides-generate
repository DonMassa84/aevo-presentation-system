#!/usr/bin/env bash
set -euo pipefail
MODE="${1:-pruefung}"
W="${W:-1920}"
H="${H:-1080}"

cd "${REPO_DIR:-$HOME/aevo-presentation-system}"
test -f content/theme_palette.json || { echo "FAIL: missing content/theme_palette.json"; exit 1; }

python3 -m venv .venv_slides >/dev/null 2>&1 || true
# shellcheck disable=SC1091
source .venv_slides/bin/activate
python -m pip -q install -U pip >/dev/null
python -m pip -q install pillow >/dev/null

MODE="$MODE" W="$W" H="$H" python - <<'PY'
from pathlib import Path
import os, json
from PIL import Image, ImageDraw, ImageFont

mode = os.environ.get("MODE","pruefung")
W = int(os.environ.get("W","1920"))
H = int(os.environ.get("H","1080"))

pal = json.loads(Path("content/theme_palette.json").read_text(encoding="utf-8"))
if mode not in pal:
    raise SystemExit(f"FAIL: unknown mode {mode}. Valid: {', '.join(pal.keys())}")

sem = pal[mode]["semantics"]
bg = sem["base"]
text = sem["text"]
accent = sem["accent"]
warn = sem["warn"]
danger = sem["danger"]
ok = sem.get("ok","#22C55E")

def hex2rgb(h):
    h = h.lstrip("#")
    return tuple(int(h[i:i+2],16) for i in (0,2,4))

def font_try(size, bold=False):
    candidates = [
        "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf",
        "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf" if bold else "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf",
        "/usr/share/fonts/truetype/liberation/LiberationSans-Regular.ttf",
        "/usr/share/fonts/truetype/freefont/FreeSans.ttf",
    ]
    for p in candidates:
        try:
            return ImageFont.truetype(p, size=size)
        except Exception:
            pass
    return ImageFont.load_default()

F_H1 = font_try(int(H*0.08), bold=True)
F_H2 = font_try(int(H*0.045), bold=False)
F_TX = font_try(int(H*0.038), bold=False)
F_SM = font_try(int(H*0.030), bold=False)

slides = [
    ("intro.jpg",   "AEVO PRAKTISCHE PRUEFUNG", ["Thema: AD Benutzer anlegen + berechtigen", "Ziel: 100 Punkte durch Klarheit + Struktur", "Roter Faden: Anlass -> Ziel -> Methode -> Demo -> Ueben -> LKK -> Fragen"], accent),
    ("ziel.jpg",    "ZIEL DER EINHEIT", ["Feinlernziel: Azubi legt Benutzer selbststaendig an", "Erfolgskriterium: ohne Eingriff, nach Checkliste", "Sicher: Least Privilege + Nachvollziehbarkeit"], ok),
    ("methode.jpg", "METHODE", ["4-Stufen-Methode: Vorbereiten -> Vormachen -> Nachmachen -> Ueben", "Didaktik: aktivieren, reduzieren, sichern", "Medien: AD-Console + Mini-Checkliste"], warn),
    ("demo.jpg",    "DEMO", ["Schritte: OU waehlen -> Benutzer erstellen -> Passwortregeln", "Gruppen: Rolle -> Gruppe -> Rechte", "Kontrolle: Name, Logon, Gruppenmitgliedschaften"], accent),
    ("ueben.jpg",   "UEBEN", ["Azubi erstellt Test-User komplett alleine", "Ich beobachte nur, stelle kurze Kontrollfragen", "Fehler sofort korrigieren lassen, dann wiederholen"], ok),
    ("lkk.jpg",     "LERNERFOLGSKONTROLLE", ["Arbeitsprobe: zweiter User + korrekte Gruppen", "Mundliche Kontrolle: Risiken falscher Rechte", "Dokumentation: Ausbildungsnachweis / Ticket / SOP"], warn),
    ("fragen.jpg",  "TYPISCHE PRUEFERFRAGEN", ["Warum 4-Stufen-Methode hier?", "Wie stellen Sie Datenschutz/IT-Sicherheit sicher?", "Wie beurteilen Sie objektiv? (Halo/Nikolaus vermeiden)"], danger),
]

outdir = Path("slides")
outdir.mkdir(parents=True, exist_ok=True)

for fn, title, bullets, stripe in slides:
    im = Image.new("RGB", (W,H), hex2rgb(bg))
    dr = ImageDraw.Draw(im)

    stripe_w = int(W*0.02)
    dr.rectangle([0,0,stripe_w,H], fill=hex2rgb(stripe))

    pad_x = int(W*0.06)
    y = int(H*0.10)

    dr.text((pad_x, y), title, font=F_H1, fill=hex2rgb(text))
    y += int(H*0.12)

    dr.line([pad_x, y, W-int(W*0.06), y], fill=hex2rgb(stripe), width=int(H*0.004))
    y += int(H*0.05)

    for b in bullets:
        dr.text((pad_x, y), f"â€¢ {b}", font=F_TX, fill=hex2rgb(text))
        y += int(H*0.07)

    footer = f"MODE={mode}  |  AEVO Shadow System  |  Trigger: {title.split()[0]}"
    dr.text((pad_x, H-int(H*0.06)), footer, font=F_SM, fill=hex2rgb(text))

    im.save(outdir / fn, quality=92)

print("OK: generated slides:", ", ".join([s[0] for s in slides]))
PY

deactivate >/dev/null 2>&1 || true
echo "OK: generated 7 slides in slides/ (MODE=$MODE, ${W}x${H})"
